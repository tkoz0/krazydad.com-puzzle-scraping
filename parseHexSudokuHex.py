'''
Parser for the hex sudoku pdfs. Outputs csv file to stdout.
Set INPUT_DIR to be the directory with the xml files from pdf2txt.py
Then run "python3 parseSudoku1pp.py > output.csv"
. means empty cell
'''

import os
from typing import Dict, List, Tuple, Union
import bs4
import tqdm
import re
import sys
import bz2

INPUT_DIR = 'hexsudoku_hex_xml'

# groups: difficulty, volume, book
FNAME_RE = re.compile(r'KD_HexSudoku_([A-Z][A-Z])H(\d*)_8_v(\d+).xml.bz2')

# 1024 possible positions found
POSITIONS = {
'73.016,173.438,86.359,201.182', '471.188,173.438,483.188,201.182', '106.812,438.438,118.812,466.182', '341.351,570.938,348.024,598.682',
'179.062,140.313,192.406,168.057', '278.438,504.688,291.781,532.432', '504.312,537.813,516.312,565.557', '241.976,405.313,248.648,433.057',
'238.641,405.313,251.984,433.057', '437.390,570.938,450.734,598.682', '173.062,173.438,185.062,201.182', '371.140,173.438,384.484,201.182',
'305.562,604.063,317.562,631.807', '338.688,570.938,350.688,598.682', '208.851,173.438,215.523,201.182', '39.891,372.188,53.235,399.932',
'46.562,537.813,59.907,565.557', '410.938,339.063,424.281,366.807', '410.938,471.563,424.281,499.307', '338.688,471.563,350.688,499.307',
'304.890,339.063,318.234,366.807', '510.312,305.938,523.657,333.682', '76.352,239.688,83.023,267.432', '371.812,272.813,383.812,300.557',
'338.688,637.188,350.688,664.932', '106.141,140.313,119.484,168.057', '536.765,372.188,550.110,399.932', '205.516,272.813,218.859,300.557',
'272.438,272.813,284.438,300.557', '271.765,206.563,285.109,234.307', '79.688,471.563,93.031,499.307', '407.601,206.563,414.274,234.307',
'272.438,604.063,284.438,631.807', '308.226,239.688,314.899,267.432', '305.562,405.313,317.562,433.057', '371.812,305.938,383.812,333.682',
'142.601,339.063,149.273,366.807', '506.976,438.438,513.649,466.182', '407.601,305.938,414.274,333.682', '503.640,140.313,516.985,168.057',
'175.726,372.188,182.398,399.932', '304.890,537.813,318.234,565.557', '73.688,471.563,85.688,499.307', '73.016,372.188,86.359,399.932',
'338.688,272.813,350.688,300.557', '142.601,438.438,149.273,466.182', '308.226,438.438,314.899,466.182', '536.765,272.813,550.110,300.557',
'338.015,438.438,351.359,466.182', '142.601,405.313,149.273,433.057', '139.266,405.313,152.609,433.057', '506.976,239.688,513.649,267.432',
'245.312,471.563,258.656,499.307', '73.016,504.688,86.359,532.432', '106.141,604.063,119.484,631.807', '106.812,239.688,118.812,267.432',
'371.140,272.813,384.484,300.557', '212.188,537.813,225.531,565.557', '477.188,504.688,490.531,532.432', '238.641,239.688,251.984,267.432',
'239.312,372.188,251.312,399.932', '179.062,471.563,192.406,499.307', '404.938,372.188,416.938,399.932', '206.188,305.938,218.188,333.682',
'139.938,305.938,151.938,333.682', '374.476,604.063,381.149,631.807', '43.227,570.938,49.898,598.682', '308.226,637.188,314.899,664.932',
'172.391,305.938,185.734,333.682', '540.101,239.688,546.774,267.432', '271.765,140.313,285.109,168.057', '46.562,339.063,59.907,366.807',
'139.938,372.188,151.938,399.932', '404.265,239.688,417.609,267.432', '172.391,637.188,185.734,664.932', '43.227,471.563,49.898,499.307',
'139.938,637.188,151.938,664.932', '504.312,272.813,516.312,300.557', '510.312,339.063,523.657,366.807', '208.851,206.563,215.523,234.307',
'245.312,239.688,258.656,267.432', '206.188,140.313,218.188,168.057', '43.227,206.563,49.898,234.307', '275.101,339.063,281.774,366.807',
'139.938,471.563,151.938,499.307', '46.562,305.938,59.907,333.682', '245.312,140.313,258.656,168.057', '73.016,570.938,86.359,598.682',
'238.641,272.813,251.984,300.557', '510.312,604.063,523.657,631.807', '344.688,471.563,358.031,499.307', '205.516,239.688,218.859,267.432',
'471.188,239.688,483.188,267.432', '106.141,239.688,119.484,267.432', '374.476,438.438,381.149,466.182', '271.765,504.688,285.109,532.432',
'271.765,239.688,285.109,267.432', '341.351,537.813,348.024,565.557', '473.851,173.438,480.524,201.182', '471.188,140.313,483.188,168.057',
'311.562,537.813,324.906,565.557', '477.188,305.938,490.531,333.682', '377.812,372.188,391.156,399.932', '142.601,570.938,149.273,598.682',
'106.812,504.688,118.812,532.432', '73.016,140.313,86.359,168.057', '338.688,537.813,350.688,565.557', '106.141,272.813,119.484,300.557',
'477.188,471.563,490.531,499.307', '504.312,438.438,516.312,466.182', '536.765,504.688,550.110,532.432', '444.062,637.188,457.406,664.932',
'371.140,604.063,384.484,631.807', '139.938,239.688,151.938,267.432', '106.812,372.188,118.812,399.932', '510.312,570.938,523.657,598.682',
'40.562,438.438,52.562,466.182', '341.351,140.313,348.024,168.057', '238.641,504.688,251.984,532.432', '504.312,604.063,516.312,631.807',
'208.851,537.813,215.523,565.557', '79.688,140.313,93.031,168.057', '404.938,405.313,416.938,433.057', '470.515,272.813,483.859,300.557',
'543.438,206.563,556.782,234.307', '278.438,372.188,291.781,399.932', '40.562,471.563,52.562,499.307', '341.351,372.188,348.024,399.932',
'470.515,305.938,483.859,333.682', '145.938,504.688,159.281,532.432', '278.438,305.938,291.781,333.682', '540.101,537.813,546.774,565.557',
'76.352,206.563,83.023,234.307', '404.938,239.688,416.938,267.432', '371.812,537.813,383.812,565.557', '175.726,570.938,182.398,598.682',
'112.812,637.188,126.156,664.932', '377.812,405.313,391.156,433.057', '305.562,339.063,317.562,366.807', '308.226,173.438,314.899,201.182',
'39.891,504.688,53.235,532.432', '471.188,405.313,483.188,433.057', '43.227,239.688,49.898,267.432', '344.688,405.313,358.031,433.057',
'473.851,305.938,480.524,333.682', '278.438,272.813,291.781,300.557', '540.101,471.563,546.774,499.307', '172.391,405.313,185.734,433.057',
'175.726,140.313,182.398,168.057', '278.438,471.563,291.781,499.307', '308.226,405.313,314.899,433.057', '145.938,339.063,159.281,366.807',
'311.562,140.313,324.906,168.057', '311.562,504.688,324.906,532.432', '175.726,537.813,182.398,565.557', '305.562,305.938,317.562,333.682',
'407.601,272.813,414.274,300.557', '440.726,438.438,447.399,466.182', '404.265,372.188,417.609,399.932', '145.938,637.188,159.281,664.932',
'241.976,173.438,248.648,201.182', '142.601,471.563,149.273,499.307', '338.015,173.438,351.359,201.182', '477.188,140.313,490.531,168.057',
'73.688,372.188,85.688,399.932', '341.351,504.688,348.024,532.432', '109.477,504.688,116.148,532.432', '172.391,206.563,185.734,234.307',
'46.562,272.813,59.907,300.557', '175.726,339.063,182.398,366.807', '275.101,372.188,281.774,399.932', '304.890,438.438,318.234,466.182',
'473.851,272.813,480.524,300.557', '540.101,305.938,546.774,333.682', '139.266,305.938,152.609,333.682', '543.438,305.938,556.782,333.682',
'537.438,405.313,549.438,433.057', '503.640,637.188,516.985,664.932', '271.765,438.438,285.109,466.182', '173.062,637.188,185.062,664.932',
'145.938,471.563,159.281,499.307', '172.391,537.813,185.734,565.557', '73.688,339.063,85.688,366.807', '374.476,272.813,381.149,300.557',
'139.938,537.813,151.938,565.557', '239.312,239.688,251.312,267.432', '477.188,272.813,490.531,300.557', '308.226,604.063,314.899,631.807',
'506.976,372.188,513.649,399.932', '239.312,405.313,251.312,433.057', '371.140,405.313,384.484,433.057', '245.312,405.313,258.656,433.057',
'338.015,206.563,351.359,234.307', '179.062,305.938,192.406,333.682', '173.062,471.563,185.062,499.307', '338.688,504.688,350.688,532.432',
'510.312,372.188,523.657,399.932', '271.765,305.938,285.109,333.682', '438.062,140.313,450.062,168.057', '106.141,173.438,119.484,201.182',
'271.765,405.313,285.109,433.057', '404.938,637.188,416.938,664.932', '106.141,405.313,119.484,433.057', '206.188,405.313,218.188,433.057',
'305.562,537.813,317.562,565.557', '377.812,604.063,391.156,631.807', '444.062,339.063,457.406,366.807', '540.101,206.563,546.774,234.307',
'371.140,471.563,384.484,499.307', '172.391,471.563,185.734,499.307', '272.438,405.313,284.438,433.057', '272.438,637.188,284.438,664.932',
'271.765,637.188,285.109,664.932', '73.688,537.813,85.688,565.557', '39.891,140.313,53.235,168.057', '109.477,305.938,116.148,333.682',
'438.062,570.938,450.062,598.682', '404.265,206.563,417.609,234.307', '142.601,140.313,149.273,168.057', '79.688,405.313,93.031,433.057',
'338.015,272.813,351.359,300.557', '40.562,272.813,52.562,300.557', '377.812,239.688,391.156,267.432', '437.390,471.563,450.734,499.307',
'304.890,140.313,318.234,168.057', '437.390,305.938,450.734,333.682', '245.312,504.688,258.656,532.432', '271.765,372.188,285.109,399.932',
'410.938,504.688,424.281,532.432', '46.562,405.313,59.907,433.057', '238.641,140.313,251.984,168.057', '73.016,471.563,86.359,499.307',
'73.016,405.313,86.359,433.057', '338.015,570.938,351.359,598.682', '503.640,239.688,516.985,267.432', '440.726,604.063,447.399,631.807',
'139.938,604.063,151.938,631.807', '504.312,570.938,516.312,598.682', '305.562,570.938,317.562,598.682', '503.640,405.313,516.985,433.057',
'374.476,405.313,381.149,433.057', '404.265,637.188,417.609,664.932', '139.266,570.938,152.609,598.682', '39.891,305.938,53.235,333.682',
'504.312,637.188,516.312,664.932', '46.562,206.563,59.907,234.307', '410.938,206.563,424.281,234.307', '39.891,272.813,53.235,300.557',
'206.188,239.688,218.188,267.432', '374.476,305.938,381.149,333.682', '344.688,305.938,358.031,333.682', '112.812,438.438,126.156,466.182',
'410.938,438.438,424.281,466.182', '40.562,604.063,52.562,631.807', '112.812,305.938,126.156,333.682', '341.351,173.438,348.024,201.182',
'407.601,405.313,414.274,433.057', '410.938,272.813,424.281,300.557', '139.266,239.688,152.609,267.432', '308.226,305.938,314.899,333.682',
'338.688,438.438,350.688,466.182', '437.390,206.563,450.734,234.307', '438.062,372.188,450.062,399.932', '172.391,173.438,185.734,201.182',
'241.976,305.938,248.648,333.682', '371.812,637.188,383.812,664.932', '473.851,438.438,480.524,466.182', '377.812,272.813,391.156,300.557',
'377.812,339.063,391.156,366.807', '73.016,239.688,86.359,267.432', '112.812,206.563,126.156,234.307', '142.601,305.938,149.273,333.682',
'410.938,405.313,424.281,433.057', '271.765,173.438,285.109,201.182', '43.227,372.188,49.898,399.932', '506.976,206.563,513.649,234.307',
'371.812,239.688,383.812,267.432', '540.101,372.188,546.774,399.932', '172.391,372.188,185.734,399.932', '112.812,570.938,126.156,598.682',
'536.765,239.688,550.110,267.432', '205.516,372.188,218.859,399.932', '440.726,570.938,447.399,598.682', '106.812,339.063,118.812,366.807',
'79.688,504.688,93.031,532.432', '473.851,471.563,480.524,499.307', '308.226,504.688,314.899,532.432', '139.266,339.063,152.609,366.807',
'145.938,140.313,159.281,168.057', '543.438,140.313,556.782,168.057', '272.438,372.188,284.438,399.932', '205.516,537.813,218.859,565.557',
'212.188,206.563,225.531,234.307', '338.688,239.688,350.688,267.432', '410.938,637.188,424.281,664.932', '76.352,372.188,83.023,399.932',
'304.890,272.813,318.234,300.557', '374.476,471.563,381.149,499.307', '39.891,604.063,53.235,631.807', '341.351,471.563,348.024,499.307',
'239.312,173.438,251.312,201.182', '341.351,206.563,348.024,234.307', '172.391,140.313,185.734,168.057', '341.351,405.313,348.024,433.057',
'510.312,504.688,523.657,532.432', '344.688,570.938,358.031,598.682', '272.438,140.313,284.438,168.057', '139.938,405.313,151.938,433.057',
'440.726,239.688,447.399,267.432', '112.812,140.313,126.156,168.057', '179.062,405.313,192.406,433.057', '410.938,173.438,424.281,201.182',
'73.688,637.188,85.688,664.932', '212.188,339.063,225.531,366.807', '371.812,339.063,383.812,366.807', '477.188,537.813,490.531,565.557',
'46.562,637.188,59.907,664.932', '39.891,471.563,53.235,499.307', '39.891,239.688,53.235,267.432', '40.562,372.188,52.562,399.932',
'73.016,438.438,86.359,466.182', '172.391,570.938,185.734,598.682', '338.015,305.938,351.359,333.682', '112.812,405.313,126.156,433.057',
'437.390,438.438,450.734,466.182', '73.016,272.813,86.359,300.557', '344.688,438.438,358.031,466.182', '470.515,372.188,483.859,399.932',
'338.688,206.563,350.688,234.307', '208.851,372.188,215.523,399.932', '404.938,173.438,416.938,201.182', '404.938,339.063,416.938,366.807',
'506.976,471.563,513.649,499.307', '208.851,570.938,215.523,598.682', '73.688,405.313,85.688,433.057', '76.352,140.313,83.023,168.057',
'437.390,604.063,450.734,631.807', '437.390,637.188,450.734,664.932', '371.812,372.188,383.812,399.932', '278.438,173.438,291.781,201.182',
'145.938,173.438,159.281,201.182', '338.015,504.688,351.359,532.432', '43.227,438.438,49.898,466.182', '43.227,405.313,49.898,433.057',
'374.476,537.813,381.149,565.557', '208.851,272.813,215.523,300.557', '444.062,372.188,457.406,399.932', '79.688,173.438,93.031,201.182',
'473.851,339.063,480.524,366.807', '106.812,405.313,118.812,433.057', '311.562,206.563,324.906,234.307', '109.477,206.563,116.148,234.307',
'543.438,239.688,556.782,267.432', '377.812,537.813,391.156,565.557', '79.688,570.938,93.031,598.682', '504.312,305.938,516.312,333.682',
'175.726,504.688,182.398,532.432', '377.812,504.688,391.156,532.432', '503.640,537.813,516.985,565.557', '212.188,438.438,225.531,466.182',
'407.601,140.313,414.274,168.057', '145.938,272.813,159.281,300.557', '139.266,471.563,152.609,499.307', '239.312,140.313,251.312,168.057',
'506.976,504.688,513.649,532.432', '374.476,372.188,381.149,399.932', '305.562,272.813,317.562,300.557', '212.188,637.188,225.531,664.932',
'503.640,438.438,516.985,466.182', '278.438,438.438,291.781,466.182', '275.101,173.438,281.774,201.182', '208.851,637.188,215.523,664.932',
'311.562,372.188,324.906,399.932', '76.352,504.688,83.023,532.432', '437.390,140.313,450.734,168.057', '374.476,140.313,381.149,168.057',
'271.765,339.063,285.109,366.807', '272.438,570.938,284.438,598.682', '275.101,570.938,281.774,598.682', '510.312,438.438,523.657,466.182',
'205.516,140.313,218.859,168.057', '43.227,637.188,49.898,664.932', '206.188,504.688,218.188,532.432', '275.101,272.813,281.774,300.557',
'142.601,537.813,149.273,565.557', '112.812,604.063,126.156,631.807', '241.976,471.563,248.648,499.307', '404.265,339.063,417.609,366.807',
'142.601,372.188,149.273,399.932', '311.562,305.938,324.906,333.682', '543.438,372.188,556.782,399.932', '543.438,504.688,556.782,532.432',
'40.562,173.438,52.562,201.182', '438.062,604.063,450.062,631.807', '407.601,570.938,414.274,598.682', '311.562,570.938,324.906,598.682',
'79.688,537.813,93.031,565.557', '371.140,637.188,384.484,664.932', '175.726,173.438,182.398,201.182', '338.015,140.313,351.359,168.057',
'404.938,438.438,416.938,466.182', '205.516,604.063,218.859,631.807', '46.562,239.688,59.907,267.432', '139.266,272.813,152.609,300.557',
'205.516,405.313,218.859,433.057', '470.515,570.938,483.859,598.682', '404.265,405.313,417.609,433.057', '438.062,173.438,450.062,201.182',
'471.188,272.813,483.188,300.557', '444.062,471.563,457.406,499.307', '471.188,570.938,483.188,598.682', '506.976,405.313,513.649,433.057',
'444.062,537.813,457.406,565.557', '470.515,239.688,483.859,267.432', '145.938,438.438,159.281,466.182', '543.438,570.938,556.782,598.682',
'139.266,504.688,152.609,532.432', '407.601,438.438,414.274,466.182', '536.765,173.438,550.110,201.182', '471.188,537.813,483.188,565.557',
'43.227,173.438,49.898,201.182', '39.891,537.813,53.235,565.557', '537.438,206.563,549.438,234.307', '175.726,637.188,182.398,664.932',
'410.938,239.688,424.281,267.432', '206.188,537.813,218.188,565.557', '139.266,537.813,152.609,565.557', '537.438,504.688,549.438,532.432',
'404.938,206.563,416.938,234.307', '540.101,570.938,546.774,598.682', '179.062,372.188,192.406,399.932', '79.688,206.563,93.031,234.307',
'305.562,471.563,317.562,499.307', '371.140,570.938,384.484,598.682', '371.140,140.313,384.484,168.057', '440.726,305.938,447.399,333.682',
'272.438,339.063,284.438,366.807', '76.352,305.938,83.023,333.682', '510.312,206.563,523.657,234.307', '304.890,637.188,318.234,664.932',
'145.938,305.938,159.281,333.682', '404.938,537.813,416.938,565.557', '272.438,537.813,284.438,565.557', '73.016,537.813,86.359,565.557',
'142.601,239.688,149.273,267.432', '241.976,637.188,248.648,664.932', '537.438,140.313,549.438,168.057', '241.976,570.938,248.648,598.682',
'112.812,339.063,126.156,366.807', '438.062,637.188,450.062,664.932', '238.641,537.813,251.984,565.557', '73.688,239.688,85.688,267.432',
'410.938,372.188,424.281,399.932', '471.188,305.938,483.188,333.682', '503.640,570.938,516.985,598.682', '106.812,537.813,118.812,565.557',
'39.891,637.188,53.235,664.932', '205.516,637.188,218.859,664.932', '139.938,570.938,151.938,598.682', '536.765,305.938,550.110,333.682',
'305.562,438.438,317.562,466.182', '106.141,570.938,119.484,598.682', '212.188,272.813,225.531,300.557', '241.976,504.688,248.648,532.432',
'338.015,471.563,351.359,499.307', '142.601,173.438,149.273,201.182', '540.101,438.438,546.774,466.182', '139.266,372.188,152.609,399.932',
'304.890,206.563,318.234,234.307', '79.688,372.188,93.031,399.932', '106.141,537.813,119.484,565.557', '175.726,272.813,182.398,300.557',
'139.266,604.063,152.609,631.807', '275.101,438.438,281.774,466.182', '238.641,339.063,251.984,366.807', '206.188,372.188,218.188,399.932',
'477.188,372.188,490.531,399.932', '473.851,372.188,480.524,399.932', '271.765,471.563,285.109,499.307', '308.226,272.813,314.899,300.557',
'238.641,206.563,251.984,234.307', '504.312,239.688,516.312,267.432', '212.188,504.688,225.531,532.432', '271.765,537.813,285.109,565.557',
'510.312,272.813,523.657,300.557', '73.016,339.063,86.359,366.807', '239.312,272.813,251.312,300.557', '371.812,471.563,383.812,499.307',
'238.641,305.938,251.984,333.682', '404.938,471.563,416.938,499.307', '438.062,537.813,450.062,565.557', '239.312,570.938,251.312,598.682',
'241.976,537.813,248.648,565.557', '40.562,570.938,52.562,598.682', '205.516,339.063,218.859,366.807', '106.141,504.688,119.484,532.432',
'510.312,405.313,523.657,433.057', '470.515,637.188,483.859,664.932', '239.312,305.938,251.312,333.682', '145.938,239.688,159.281,267.432',
'245.312,438.438,258.656,466.182', '212.188,173.438,225.531,201.182', '106.812,173.438,118.812,201.182', '40.562,405.313,52.562,433.057',
'404.265,604.063,417.609,631.807', '241.976,604.063,248.648,631.807', '471.188,471.563,483.188,499.307', '504.312,471.563,516.312,499.307',
'112.812,372.188,126.156,399.932', '404.938,305.938,416.938,333.682', '106.812,305.938,118.812,333.682', '404.938,570.938,416.938,598.682',
'304.890,405.313,318.234,433.057', '109.477,604.063,116.148,631.807', '371.812,570.938,383.812,598.682', '173.062,206.563,185.062,234.307',
'371.812,504.688,383.812,532.432', '311.562,339.063,324.906,366.807', '43.227,305.938,49.898,333.682', '173.062,239.688,185.062,267.432',
'305.562,140.313,317.562,168.057', '275.101,305.938,281.774,333.682', '305.562,173.438,317.562,201.182', '238.641,438.438,251.984,466.182',
'503.640,504.688,516.985,532.432', '173.062,438.438,185.062,466.182', '142.601,272.813,149.273,300.557', '172.391,339.063,185.734,366.807',
'437.390,239.688,450.734,267.432', '305.562,637.188,317.562,664.932', '404.265,438.438,417.609,466.182', '371.812,405.313,383.812,433.057',
'437.390,272.813,450.734,300.557', '311.562,239.688,324.906,267.432', '179.062,438.438,192.406,466.182', '437.390,339.063,450.734,366.807',
'239.312,438.438,251.312,466.182', '341.351,604.063,348.024,631.807', '305.562,504.688,317.562,532.432', '440.726,339.063,447.399,366.807',
'109.477,637.188,116.148,664.932', '477.188,637.188,490.531,664.932', '404.265,305.938,417.609,333.682', '344.688,537.813,358.031,565.557',
'371.140,206.563,384.484,234.307', '109.477,471.563,116.148,499.307', '43.227,140.313,49.898,168.057', '407.601,471.563,414.274,499.307',
'272.438,471.563,284.438,499.307', '272.438,239.688,284.438,267.432', '79.688,438.438,93.031,466.182', '145.938,372.188,159.281,399.932',
'173.062,272.813,185.062,300.557', '344.688,140.313,358.031,168.057', '245.312,173.438,258.656,201.182', '241.976,372.188,248.648,399.932',
'46.562,140.313,59.907,168.057', '40.562,140.313,52.562,168.057', '172.391,239.688,185.734,267.432', '73.016,604.063,86.359,631.807',
'506.976,272.813,513.649,300.557', '311.562,604.063,324.906,631.807', '338.688,604.063,350.688,631.807', '46.562,570.938,59.907,598.682',
'503.640,372.188,516.985,399.932', '338.015,372.188,351.359,399.932', '239.312,604.063,251.312,631.807', '473.851,604.063,480.524,631.807',
'76.352,339.063,83.023,366.807', '304.890,372.188,318.234,399.932', '109.477,372.188,116.148,399.932', '311.562,405.313,324.906,433.057',
'341.351,305.938,348.024,333.682', '438.062,206.563,450.062,234.307', '40.562,339.063,52.562,366.807', '304.890,173.438,318.234,201.182',
'76.352,173.438,83.023,201.182', '506.976,570.938,513.649,598.682', '208.851,239.688,215.523,267.432', '543.438,604.063,556.782,631.807',
'540.101,504.688,546.774,532.432', '371.140,305.938,384.484,333.682', '43.227,339.063,49.898,366.807', '471.188,339.063,483.188,366.807',
'46.562,438.438,59.907,466.182', '206.188,604.063,218.188,631.807', '239.312,537.813,251.312,565.557', '543.438,173.438,556.782,201.182',
'206.188,570.938,218.188,598.682', '308.226,570.938,314.899,598.682', '271.765,604.063,285.109,631.807', '239.312,637.188,251.312,664.932',
'39.891,339.063,53.235,366.807', '311.562,173.438,324.906,201.182', '338.688,173.438,350.688,201.182', '503.640,272.813,516.985,300.557',
'371.812,438.438,383.812,466.182', '304.890,504.688,318.234,532.432', '444.062,239.688,457.406,267.432', '73.016,637.188,86.359,664.932',
'338.688,372.188,350.688,399.932', '245.312,570.938,258.656,598.682', '106.812,604.063,118.812,631.807', '437.390,173.438,450.734,201.182',
'73.688,173.438,85.688,201.182', '239.312,471.563,251.312,499.307', '76.352,438.438,83.023,466.182', '109.477,239.688,116.148,267.432',
'438.062,504.688,450.062,532.432', '271.765,272.813,285.109,300.557', '205.516,504.688,218.859,532.432', '344.688,272.813,358.031,300.557',
'40.562,239.688,52.562,267.432', '341.351,438.438,348.024,466.182', '377.812,206.563,391.156,234.307', '109.477,272.813,116.148,300.557',
'175.726,471.563,182.398,499.307', '40.562,537.813,52.562,565.557', '473.851,140.313,480.524,168.057', '46.562,173.438,59.907,201.182',
'208.851,339.063,215.523,366.807', '374.476,173.438,381.149,201.182', '112.812,504.688,126.156,532.432', '444.062,604.063,457.406,631.807',
'76.352,537.813,83.023,565.557', '537.438,173.438,549.438,201.182', '206.188,471.563,218.188,499.307', '39.891,206.563,53.235,234.307',
'371.140,339.063,384.484,366.807', '272.438,206.563,284.438,234.307', '377.812,173.438,391.156,201.182', '79.688,339.063,93.031,366.807',
'506.976,339.063,513.649,366.807', '179.062,637.188,192.406,664.932', '172.391,504.688,185.734,532.432', '208.851,504.688,215.523,532.432',
'139.938,140.313,151.938,168.057', '311.562,637.188,324.906,664.932', '471.188,604.063,483.188,631.807', '139.266,438.438,152.609,466.182',
'444.062,504.688,457.406,532.432', '278.438,140.313,291.781,168.057', '175.726,305.938,182.398,333.682', '245.312,339.063,258.656,366.807',
'537.438,604.063,549.438,631.807', '76.352,637.188,83.023,664.932', '112.812,272.813,126.156,300.557', '510.312,140.313,523.657,168.057',
'212.188,570.938,225.531,598.682', '371.812,140.313,383.812,168.057', '338.015,239.688,351.359,267.432', '212.188,305.938,225.531,333.682',
'440.726,140.313,447.399,168.057', '444.062,305.938,457.406,333.682', '76.352,570.938,83.023,598.682', '473.851,504.688,480.524,532.432',
'477.188,173.438,490.531,201.182', '371.140,504.688,384.484,532.432', '212.188,471.563,225.531,499.307', '341.351,637.188,348.024,664.932',
'206.188,339.063,218.188,366.807', '404.938,504.688,416.938,532.432', '245.312,372.188,258.656,399.932', '139.266,637.188,152.609,664.932',
'139.266,206.563,152.609,234.307', '440.726,405.313,447.399,433.057', '275.101,604.063,281.774,631.807', '540.101,140.313,546.774,168.057',
'278.438,570.938,291.781,598.682', '371.812,604.063,383.812,631.807', '271.765,570.938,285.109,598.682', '173.062,339.063,185.062,366.807',
'241.976,438.438,248.648,466.182', '275.101,504.688,281.774,532.432', '79.688,305.938,93.031,333.682', '404.938,604.063,416.938,631.807',
'109.477,405.313,116.148,433.057', '536.765,140.313,550.110,168.057', '543.438,438.438,556.782,466.182', '440.726,504.688,447.399,532.432',
'208.851,471.563,215.523,499.307', '39.891,173.438,53.235,201.182', '39.891,405.313,53.235,433.057', '504.312,173.438,516.312,201.182',
'142.601,206.563,149.273,234.307', '444.062,206.563,457.406,234.307', '106.812,272.813,118.812,300.557', '205.516,305.938,218.859,333.682',
'208.851,438.438,215.523,466.182', '444.062,140.313,457.406,168.057', '238.641,637.188,251.984,664.932', '238.641,570.938,251.984,598.682',
'239.312,339.063,251.312,366.807', '179.062,504.688,192.406,532.432', '43.227,537.813,49.898,565.557', '338.015,604.063,351.359,631.807',
'238.641,471.563,251.984,499.307', '437.390,405.313,450.734,433.057', '503.640,305.938,516.985,333.682', '205.516,471.563,218.859,499.307',
'106.141,637.188,119.484,664.932', '407.601,372.188,414.274,399.932', '311.562,471.563,324.906,499.307', '278.438,206.563,291.781,234.307',
'179.062,604.063,192.406,631.807', '404.265,471.563,417.609,499.307', '344.688,206.563,358.031,234.307', '212.188,604.063,225.531,631.807',
'404.938,140.313,416.938,168.057', '241.976,272.813,248.648,300.557', '536.765,405.313,550.110,433.057', '76.352,272.813,83.023,300.557',
'444.062,438.438,457.406,466.182', '470.515,140.313,483.859,168.057', '172.391,272.813,185.734,300.557', '473.851,206.563,480.524,234.307',
'371.140,438.438,384.484,466.182', '338.015,405.313,351.359,433.057', '238.641,173.438,251.984,201.182', '275.101,471.563,281.774,499.307',
'404.265,570.938,417.609,598.682', '470.515,405.313,483.859,433.057', '73.688,305.938,85.688,333.682', '504.312,405.313,516.312,433.057',
'438.062,239.688,450.062,267.432', '444.062,405.313,457.406,433.057', '404.265,173.438,417.609,201.182', '106.141,339.063,119.484,366.807',
'241.976,239.688,248.648,267.432', '106.141,305.938,119.484,333.682', '540.101,173.438,546.774,201.182', '212.188,140.313,225.531,168.057',
'308.226,537.813,314.899,565.557', '241.976,339.063,248.648,366.807', '471.188,206.563,483.188,234.307', '477.188,570.938,490.531,598.682',
'46.562,372.188,59.907,399.932', '377.812,570.938,391.156,598.682', '407.601,239.688,414.274,267.432', '308.226,140.313,314.899,168.057',
'112.812,471.563,126.156,499.307', '374.476,206.563,381.149,234.307', '338.688,305.938,350.688,333.682', '410.938,140.313,424.281,168.057',
'410.938,604.063,424.281,631.807', '179.062,537.813,192.406,565.557', '241.976,140.313,248.648,168.057', '503.640,173.438,516.985,201.182',
'46.562,604.063,59.907,631.807', '344.688,173.438,358.031,201.182', '208.851,604.063,215.523,631.807', '473.851,570.938,480.524,598.682',
'239.312,504.688,251.312,532.432', '470.515,537.813,483.859,565.557', '73.688,504.688,85.688,532.432', '404.265,140.313,417.609,168.057',
'305.562,206.563,317.562,234.307', '179.062,570.938,192.406,598.682', '145.938,570.938,159.281,598.682', '275.101,537.813,281.774,565.557',
'338.015,637.188,351.359,664.932', '503.640,604.063,516.985,631.807', '471.188,438.438,483.188,466.182', '173.062,140.313,185.062,168.057',
'536.765,537.813,550.110,565.557', '407.601,604.063,414.274,631.807', '275.101,140.313,281.774,168.057', '344.688,504.688,358.031,532.432',
'537.438,272.813,549.438,300.557', '142.601,637.188,149.273,664.932', '470.515,173.438,483.859,201.182', '173.062,604.063,185.062,631.807',
'503.640,206.563,516.985,234.307', '510.312,637.188,523.657,664.932', '106.812,140.313,118.812,168.057', '173.062,570.938,185.062,598.682',
'543.438,405.313,556.782,433.057', '179.062,339.063,192.406,366.807', '510.312,173.438,523.657,201.182', '175.726,438.438,182.398,466.182',
'305.562,372.188,317.562,399.932', '510.312,537.813,523.657,565.557', '272.438,305.938,284.438,333.682', '139.938,173.438,151.938,201.182',
'206.188,173.438,218.188,201.182', '444.062,272.813,457.406,300.557', '142.601,504.688,149.273,532.432', '506.976,604.063,513.649,631.807',
'438.062,305.938,450.062,333.682', '206.188,206.563,218.188,234.307', '477.188,438.438,490.531,466.182', '112.812,239.688,126.156,267.432',
'410.938,305.938,424.281,333.682', '371.140,537.813,384.484,565.557', '477.188,604.063,490.531,631.807', '179.062,239.688,192.406,267.432',
'73.688,570.938,85.688,598.682', '208.851,405.313,215.523,433.057', '73.688,438.438,85.688,466.182', '407.601,637.188,414.274,664.932',
'73.688,604.063,85.688,631.807', '540.101,604.063,546.774,631.807', '470.515,504.688,483.859,532.432', '109.477,438.438,116.148,466.182',
'206.188,637.188,218.188,664.932', '470.515,339.063,483.859,366.807', '540.101,405.313,546.774,433.057', '304.890,471.563,318.234,499.307',
'371.140,239.688,384.484,267.432', '106.141,438.438,119.484,466.182', '473.851,537.813,480.524,565.557', '371.812,173.438,383.812,201.182',
'43.227,604.063,49.898,631.807', '473.851,637.188,480.524,664.932', '106.141,372.188,119.484,399.932', '503.640,471.563,516.985,499.307',
'308.226,339.063,314.899,366.807', '377.812,471.563,391.156,499.307', '208.851,140.313,215.523,168.057', '175.726,239.688,182.398,267.432',
'404.938,272.813,416.938,300.557', '471.188,372.188,483.188,399.932', '438.062,405.313,450.062,433.057', '438.062,471.563,450.062,499.307',
'212.188,405.313,225.531,433.057', '510.312,471.563,523.657,499.307', '79.688,604.063,93.031,631.807', '536.765,438.438,550.110,466.182',
'338.015,339.063,351.359,366.807', '205.516,570.938,218.859,598.682', '377.812,438.438,391.156,466.182', '540.101,637.188,546.774,664.932',
'73.688,140.313,85.688,168.057', '106.141,471.563,119.484,499.307', '543.438,339.063,556.782,366.807', '440.726,206.563,447.399,234.307',
'308.226,206.563,314.899,234.307', '304.890,305.938,318.234,333.682', '106.812,471.563,118.812,499.307', '543.438,471.563,556.782,499.307',
'278.438,339.063,291.781,366.807', '503.640,339.063,516.985,366.807', '537.438,438.438,549.438,466.182', '438.062,339.063,450.062,366.807',
'172.391,604.063,185.734,631.807', '407.601,339.063,414.274,366.807', '371.140,372.188,384.484,399.932', '304.890,570.938,318.234,598.682',
'344.688,239.688,358.031,267.432', '438.062,438.438,450.062,466.182', '338.688,339.063,350.688,366.807', '275.101,239.688,281.774,267.432',
'76.352,405.313,83.023,433.057', '275.101,405.313,281.774,433.057', '206.188,438.438,218.188,466.182', '344.688,372.188,358.031,399.932',
'79.688,239.688,93.031,267.432', '109.477,570.938,116.148,598.682', '374.476,239.688,381.149,267.432', '278.438,405.313,291.781,433.057',
'510.312,239.688,523.657,267.432', '504.312,339.063,516.312,366.807', '275.101,637.188,281.774,664.932', '112.812,537.813,126.156,565.557',
'543.438,537.813,556.782,565.557', '106.812,637.188,118.812,664.932', '344.688,637.188,358.031,664.932', '471.188,504.688,483.188,532.432',
'179.062,206.563,192.406,234.307', '536.765,206.563,550.110,234.307', '537.438,537.813,549.438,565.557', '175.726,405.313,182.398,433.057',
'175.726,206.563,182.398,234.307', '305.562,239.688,317.562,267.432', '179.062,173.438,192.406,201.182', '275.101,206.563,281.774,234.307',
'504.312,372.188,516.312,399.932', '139.266,173.438,152.609,201.182', '109.477,537.813,116.148,565.557', '536.765,471.563,550.110,499.307',
'407.601,173.438,414.274,201.182', '470.515,604.063,483.859,631.807', '504.312,140.313,516.312,168.057', '377.812,140.313,391.156,168.057',
'106.812,570.938,118.812,598.682', '272.438,173.438,284.438,201.182', '537.438,372.188,549.438,399.932', '173.062,405.313,185.062,433.057',
'175.726,604.063,182.398,631.807', '410.938,570.938,424.281,598.682', '76.352,604.063,83.023,631.807', '338.688,140.313,350.688,168.057',
'73.016,305.938,86.359,333.682', '477.188,206.563,490.531,234.307', '46.562,504.688,59.907,532.432', '440.726,173.438,447.399,201.182',
'437.390,537.813,450.734,565.557', '374.476,504.688,381.149,532.432', '440.726,272.813,447.399,300.557', '506.976,305.938,513.649,333.682',
'473.851,239.688,480.524,267.432', '304.890,604.063,318.234,631.807', '112.812,173.438,126.156,201.182', '540.101,272.813,546.774,300.557',
'377.812,637.188,391.156,664.932', '308.226,372.188,314.899,399.932', '537.438,305.938,549.438,333.682', '543.438,272.813,556.782,300.557',
'73.016,206.563,86.359,234.307', '444.062,570.938,457.406,598.682', '536.765,637.188,550.110,664.932', '109.477,140.313,116.148,168.057',
'172.391,438.438,185.734,466.182', '272.438,504.688,284.438,532.432', '506.976,537.813,513.649,565.557', '239.312,206.563,251.312,234.307',
'477.188,239.688,490.531,267.432', '506.976,637.188,513.649,664.932', '537.438,339.063,549.438,366.807', '304.890,239.688,318.234,267.432',
'407.601,537.813,414.274,565.557', '278.438,604.063,291.781,631.807', '440.726,372.188,447.399,399.932', '145.938,537.813,159.281,565.557',
'477.188,339.063,490.531,366.807', '145.938,604.063,159.281,631.807', '238.641,372.188,251.984,399.932', '536.765,604.063,550.110,631.807',
'106.141,206.563,119.484,234.307', '536.765,570.938,550.110,598.682', '278.438,637.188,291.781,664.932', '470.515,438.438,483.859,466.182',
'205.516,438.438,218.859,466.182', '43.227,272.813,49.898,300.557', '39.891,570.938,53.235,598.682', '205.516,173.438,218.859,201.182',
'272.438,438.438,284.438,466.182', '537.438,570.938,549.438,598.682', '79.688,637.188,93.031,664.932', '208.851,305.938,215.523,333.682',
'537.438,637.188,549.438,664.932', '440.726,471.563,447.399,499.307', '440.726,537.813,447.399,565.557', '407.601,504.688,414.274,532.432',
'139.938,504.688,151.938,532.432', '39.891,438.438,53.235,466.182', '278.438,537.813,291.781,565.557', '40.562,637.188,52.562,664.932',
'470.515,206.563,483.859,234.307', '139.938,206.563,151.938,234.307', '543.438,637.188,556.782,664.932', '145.938,206.563,159.281,234.307',
'311.562,272.813,324.906,300.557', '371.812,206.563,383.812,234.307', '238.641,604.063,251.984,631.807', '245.312,272.813,258.656,300.557',
'139.938,438.438,151.938,466.182', '377.812,305.938,391.156,333.682', '278.438,239.688,291.781,267.432', '404.265,504.688,417.609,532.432',
'139.266,140.313,152.609,168.057', '173.062,504.688,185.062,532.432', '444.062,173.438,457.406,201.182', '40.562,305.938,52.562,333.682',
'206.188,272.813,218.188,300.557', '142.601,604.063,149.273,631.807', '179.062,272.813,192.406,300.557', '341.351,339.063,348.024,366.807',
'173.062,372.188,185.062,399.932', '241.976,206.563,248.648,234.307', '504.312,504.688,516.312,532.432', '212.188,372.188,225.531,399.932',
'477.188,405.313,490.531,433.057', '504.312,206.563,516.312,234.307', '40.562,504.688,52.562,532.432', '437.390,504.688,450.734,532.432',
'212.188,239.688,225.531,267.432', '537.438,239.688,549.438,267.432', '470.515,471.563,483.859,499.307', '245.312,637.188,258.656,664.932',
'338.688,405.313,350.688,433.057', '139.938,339.063,151.938,366.807', '410.938,537.813,424.281,565.557', '205.516,206.563,218.859,234.307',
'43.227,504.688,49.898,532.432', '106.812,206.563,118.812,234.307', '173.062,305.938,185.062,333.682', '145.938,405.313,159.281,433.057',
'471.188,637.188,483.188,664.932', '341.351,239.688,348.024,267.432', '374.476,339.063,381.149,366.807', '40.562,206.563,52.562,234.307',
'109.477,339.063,116.148,366.807', '344.688,604.063,358.031,631.807', '536.765,339.063,550.110,366.807', '537.438,471.563,549.438,499.307',
'73.688,206.563,85.688,234.307', '404.265,537.813,417.609,565.557', '79.688,272.813,93.031,300.557', '338.015,537.813,351.359,565.557',
'173.062,537.813,185.062,565.557', '374.476,637.188,381.149,664.932', '540.101,339.063,546.774,366.807', '437.390,372.188,450.734,399.932',
'73.688,272.813,85.688,300.557', '438.062,272.813,450.062,300.557', '311.562,438.438,324.906,466.182', '440.726,637.188,447.399,664.932',
'404.265,272.813,417.609,300.557', '46.562,471.563,59.907,499.307', '344.688,339.063,358.031,366.807', '245.312,206.563,258.656,234.307',
'245.312,604.063,258.656,631.807', '139.938,272.813,151.938,300.557', '109.477,173.438,116.148,201.182', '245.312,537.813,258.656,565.557',
'341.351,272.813,348.024,300.557', '506.976,140.313,513.649,168.057', '308.226,471.563,314.899,499.307', '374.476,570.938,381.149,598.682',
'76.352,471.563,83.023,499.307', '245.312,305.938,258.656,333.682', '506.976,173.438,513.649,201.182', '473.851,405.313,480.524,433.057'}

_x0=set()
_y0=set()
for p in POSITIONS:
    x0,y0,_,_ = map(float,p.split(','))
    _x0.add(x0)
    _y0.add(y0)
#print(len(_x0),sorted(_x0))
#print(len(_y0),sorted(_y0))
_x0=sorted(_x0) # 64 possible values -> index//4 gives the column (likely due to some symbols being wider than others)
_y0=sorted(_y0) # 16 possible values -> translates nicely to row
POS_MAP: Dict[str,Tuple[int,int]] = dict()
for p in POSITIONS:
    x0,y0,_,_ = map(float,p.split(','))
    r = 15-_y0.index(y0)
    c = _x0.index(x0)//4
    POS_MAP[p] = (r,c)

def extract_text(xml: bs4.BeautifulSoup) -> List[Dict[str,str]]:
    # expects 8 pages with puzzles (id=1,2,3,4,5,6,7,8)
    # (9 and 10 are hints and answers, do not care about those)
    # page num -> page object
    pages = {page.attrs['id']: page for page in xml.findAll('page')}
    assert len(pages) == 10
    result: List[Dict[str,str]] = [] # for each puzzle (1..8) the (position -> digit) mapping
    for page in range(1,9):
        page = pages[str(page)]
        # sudoku cells have font="Helvetica" and size="27.744"
        raw_cells = page.findAll('text',attrs={'font':'Helvetica','size':'27.744'})
        # position -> digit
        cells: Dict[str,str] = {cell.attrs['bbox']: cell.text for cell in raw_cells}
        # sanity check
        assert 50 <= len(cells) <= 120
        for v in cells.values():
            assert len(v) == 1 and v in '0123456789abcdef'
        result.append(cells)
    return result

def allowed_digits(puzzle: List[List[int]], r: int, c: int) -> List[bool]:
    br,bc = (r//4)*4, (c//4)*4 # upper left of block
    digits = [True]*17
    for i in range(16):
        digits[puzzle[r][i]] = False # row
        digits[puzzle[i][c]] = False # col
        digits[puzzle[br+(i//4)][bc+(i%4)]] = False # block
    return digits

def first_empty_cell(puzzle: List[List[int]]) -> Union[Tuple[int,int],None]:
    for r in range(16):
        for c in range(16):
            if puzzle[r][c] == 0:
                return r,c

def solved(puzzle: List[List[int]]) -> bool:
    digits = set(range(1,17))
    for i in range(16):
        if set(puzzle[i]) != digits: return False
        if set(puzzle[j][i] for j in range(16)) != digits: return False
        br,bc = divmod(i,4)
        if set(puzzle[4*br+j][4*bc+k] for j in range(4) for k in range(4)) != digits: return False
    return True

# constraint propagation
def propagate(allowed: List[List[List[bool]]], r: int, c: int, n: int):
    for i in range(16):
        allowed[r][i][n] = False
        allowed[i][c][n] = False
        br,bc = 4*(r//4),4*(c//4)
        dr,dc = divmod(i,4)
        allowed[br+dr][bc+dc][n] = False

# improved sudoku solver because it is too slow on the difficult puzzles
#_maxfec=0
def solve_recur(puzzle: List[List[int]]) -> List[List[List[int]]]:
    #global _maxfec
    #print('\n'.join(''.join('%3d'%n for n in row) for row in puzzle)+'\n--')
    allowed = [[allowed_digits(puzzle,r,c) for c in range(16)] for r in range(16)]
    #print(set(sum(1 for a in allowed[r][c][1:] if a) for r in range(16) for c in range(16)))
    #print(set((r,c) for r in range(16) for c in range(16) if sum(1 for a in allowed[r][c][1:] if a) == 1 and puzzle[r][c] == 0))
    #_allownum = [[-1 if puzzle[r][c] else sum(1 for a in allowed[r][c][1:] if a) for c in range(16)] for r in range(16)]
    #print('\n'.join(''.join('%3d'%n for n in row) for row in _allownum)+'\n--')
    while True: # try solving techniques
        changed = False
        for r in range(16): # cell with 1 possibility
            for c in range(16):
                if puzzle[r][c] != 0:
                    continue
                digits = allowed[r][c]
                i = 1 # find first true
                while i < 17 and not digits[i]: i += 1
                if i < 17 and not any(digits[i+1:]):
                    puzzle[r][c] = i
                    propagate(allowed,r,c,i)
                    changed = True
                if i == 17: return [] # impossible to solve
        for i in range(16): # row/col/block with 1 location for a number
            br,bc = divmod(i,4)
            for n in range(1,17): # digit
                # n in row i
                if n not in puzzle[i]:
                    pos = []
                    for c,digits in enumerate(allowed[i]):
                        if puzzle[i][c] == 0 and digits[n]: pos.append((i,c))
                    if len(pos) == 0:
                        return [] # impossible
                    if len(pos) == 1:
                        rr,cc = pos[0]
                        puzzle[rr][cc] = n
                        propagate(allowed,rr,cc,n)
                        changed = True
                # n in col i
                if n not in [puzzle[r][i] for r in range(16)]:
                    pos = []
                    for r in range(16):
                        if puzzle[r][i] == 0 and allowed[r][i][n]: pos.append((r,i))
                    if len(pos) == 0:
                        return [] # impossible
                    if len(pos) == 1:
                        rr,cc = pos[0]
                        puzzle[rr][cc] = n
                        propagate(allowed,rr,cc,n)
                        changed = True
                # n in block br,bc
                if n not in [puzzle[r][c] for r in range(4*br,4*br+4) for c in range(4*bc,4*bc+4)]:
                    pos = []
                    for dr in range(4):
                        for dc in range(4):
                            if puzzle[4*br+dr][4*bc+dc] == 0 and allowed[4*br+dr][4*bc+dc][n]:
                                pos.append((4*br+dr,4*bc+dc))
                    #print(n,'in block',br,bc,'has',len(pos),'possible')
                    if len(pos) == 0:
                        return [] # impossible
                    if len(pos) == 1:
                        rr,cc = pos[0]
                        puzzle[rr][cc] = n
                        propagate(allowed,rr,cc,n)
                        changed = True
        if not changed:
            break
    fec = first_empty_cell(puzzle)
    if fec is None: # filled
        assert solved(puzzle), '\n'+'\n'.join(str(row) for row in puzzle)
        return [[row[:] for row in puzzle]]
    # take a guess
    r,c = fec
    # adjust guess to a cell with (hopefully) 2 possibilities
    for gc in range(16*r+c,256):
        rr,cc = divmod(gc,16)
        if puzzle[rr][cc] == 0 and sum(1 for a in allowed[rr][cc][1:] if a) < sum(1 for a in allowed[r][c][1:] if a):
            r,c = rr,cc
    #if 16*r+c>_maxfec:print('fec',16*r+c);_maxfec=16*r+c;print('\n'.join(''.join('%3d'%n for n in row) for row in puzzle)+'\n--');quit()
    assert puzzle[r][c] == 0
    digits = allowed_digits(puzzle,r,c)
    solns = []
    for d in range(1,17):
        if not digits[d]:
            continue
        puzzle_copy = [row[:] for row in puzzle]
        puzzle_copy[r][c] = d
        solns += solve_recur(puzzle_copy)
        if len(solns) > 1: break # error if >1 solution
    return [] if len(solns) > 1 else solns

def make_puzzle(pos_map: Dict[str,Tuple[int,int]], page_items: Dict[str,str]) -> List[List[int]]:
    global _p
    puzzle = [[0]*16 for _ in range(16)]
    for pos,digit in page_items.items():
        digit = int(digit,16)+1 # since 0 is included
        r,c = pos_map[pos]
        assert puzzle[r][c] == 0
        assert 1 <= digit <= 16
        puzzle[r][c] = digit
    puzzle_copy = [row[:] for row in puzzle]
    solns = solve_recur(puzzle_copy)
    assert len(solns) == 1
    return puzzle

# difficulty(7 levels), vol(1..20 currently), book(1..100)
def _files_sort(file: str) -> int:
    match = FNAME_RE.fullmatch(file)
    assert match
    dif,vol,book = match.groups()
    vol = 1 if vol == '' else int(vol)
    book = int(book)
    diffs = ['EZ','NO','IM','CH','TF','ST','IN']
    return diffs.index(dif)*1000000 + vol*1000 + book

files = sorted(os.listdir(INPUT_DIR), key=_files_sort)
#import random
#random.shuffle(files)

print('DIFFICULTY,VOLUME,BOOK,NUMBER,PUZZLE') # header row

for file in tqdm.tqdm(files):
    match = FNAME_RE.fullmatch(file)
    assert match
    dif,vol,book = match.groups()
    vol = 1 if vol == '' else int(vol)
    book = int(book)
    tqdm.tqdm.write('parsing: '+file+' (dif = %s, vol = %d, book = %d)'%(dif,vol,book), sys.stderr)
    file = INPUT_DIR+'/'+file
    file_data = bz2.open(file,'rt').read()
    assert file_data.splitlines()[-1] == '</pages>', file_data.splitlines()[-1] # check if file is complete
    xml = bs4.BeautifulSoup(file_data,features='xml')
    text = extract_text(xml)
    for p,page in enumerate(text):
        #_p|=set(page.keys())
        #continue
        #tqdm.tqdm.write('- puzzle '+str(p+1), sys.stderr)
        puzzle = make_puzzle(POS_MAP,page)
        # convert to string of 256 chars
        puzzle_str = ''.join(''.join('.' if n == 0 else '0123456789abcdef'[n-1] for n in row) for row in puzzle)
        print('%s,%d,%d,%d,%s'%(dif,vol,book,p+1,puzzle_str))
